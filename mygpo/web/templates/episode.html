{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load episodes %}
{% load devices %}
{% load podcasts %}
{% load mygpoutil %}
{% load time %}
{% load youtube %}

{% load menu %}
{% block mainmenu %}{{ "/podcast/"|main_menu }}{% endblock %}
{% block sectionmenu %}
 {% if episode.podcast.title %}
  {{ "/podcast/"|section_menu:episode.podcast.title }}
 {% else %}
  {{ "/podcast/"|section_menu:"Unnamed Podcast" }}
 {% endif %}
{% endblock %}

{% block head %}
 <script type="text/javascript" src="/media/js/jquery-1.4.2.min.js"></script>
 <script type="text/javascript" src="/media/js/jquery.watermark.min.js"></script>
 {% if episode.url|is_youtube_video %}
  <script type="text/javascript" src="/media/js/swfobject.js"></script>
  <script type="text/javascript" src="/media/js/json2.js"></script>
  <script type="text/javascript" src="/media/js/youtube-handler.js"></script>
 {% endif %}
{% endblock head %}

{% block title %}{{ episode.title|default:"Unnamed Episode"|striptags }} - {{ episode.podcast.title|default:"Unnamed Podcast"|striptags}}{% endblock %}

{% block content %}
  {% if episode.podcast.logo_url %}
   <div id="podcastlogo"><a href="/podcast/{{ episode.podcast.id }}">{{ episode.podcast|podcast_logo_big }}</a></div>
  {% endif %}
  <h1>{{ episode.title|default:"Unnamed Episode"|striptags }}</h1>
  <small class="description">
      {% trans "from" %} <a href="/podcast/{{ episode.podcast.id }}">{{ episode.podcast }}</a>{% if episode.timestamp %}, {% trans "released" %} {{episode.timestamp}}{% endif %},
      {% trans "links" %}:
      <a href="{{episode.url}}">{% trans "download" %}</a>{% if episode.link and episode.link != episode.url %}, <a href="{{episode.link}}">{% trans "website" %}</a>
      {% endif %},
      {% trans "stats:" %} {% blocktrans with episode.listener_count as listener_count %}{{listener_count}} listeners{% endblocktrans %}
  </small>
  <hr style="clear: none;"/>

  {% if episode.url|is_youtube_video %}
    <div id="ytapiplayer">
      You need Flash player 8+ and JavaScript enabled to view this video.
    </div>
  {% endif %}

  {% if episode.description %}
   <p>{{ episode.description|remove_html_tags|linebreaksbr }}</p>
  {% endif %}

  {% if user.is_authenticated %}

   {% if is_favorite %}
    <div>
     <a href="/episode/{{ episode.id }}/toggle-favorite">
      <img src="/media/fav.png" style="vertical-align: middle;" /> {% trans "Favorite" %}
     </a>
    </div>
   {% else %}
    <div>
     <a href="/episode/{{ episode.id }}/toggle-favorite">
      <img src="/media/fav-add.png" style="vertical-align: middle;" /> {% trans "Add as Favorite" %}
     </a>
    </div>
   {% endif %}

   {% if played_parts %}
    <h3>Already played</h3>
    {{ played_parts|played_visualization:duration }}
   {% endif %}


  <hr/>
   <h2>{% trans "Chapters" %}</h2>

   <div class="info">
    {% if not subscription_meta %}
     {% blocktrans with episode.podcast.id as podcast_id %}You aren't subscribed to this podcast. Therefor your chapters are also visible to other users. If you do no want that, <a href="/podcast/{{ podcast_id }}/subscribe">subscribe to the podcast</a> and mark your subscription as private.{% endblocktrans %}
    {% else %}
     {% if subscription_meta.public %}
      {%blocktrans with episode.podcast.id as podcast_id %}Your own chapters are shown in bold. If you don't want them to appear to other users, go to the <a href="/podcast/{{ podcast_id }}">podcast page</a> and mark your subscription as private.{% endblocktrans %}
     {% else %}
      {% blocktrans with episode.podcast.id as podcast_id %}The following list contains your chapters in bold and those of other users. However, yours are not shown to others, because you've marked your subscription as prive on the <a href="/podcast/{{ podcast_id }}">podcast page</a>. You can change that there, if you want.{% endblocktrans %}
     {% endif %}
    {% endif %}
   </div>

   <table class="list">
    <tr>
     <th></th>
     <th>{% trans "Ad?" %}</th>
     <th>{% trans "Label" %}</th>
     <th></td>
    </tr>

    {% for chapter in chapters %}
     <tr {% if chapter.user == user %}class="own-chapter"{% endif %} >
      <td>{{ chapter.start|sec_to_time|time:"H:i:s" }}{% if chapter.start != chapter.end %} - {{ chapter.end|sec_to_time|time:"H:i:s" }}{% endif %}</td>
      <td>{% if chapter.advertisement %}Yes{% endif %}</td>
      <td>{{ chapter.label }}</strong>
      <td>
       {% if chapter.user == user %}
        <a href="/episode/{{ episode.id }}/remove-chapter/{{ chapter.id}}">
         <img src="/media/unsubscribe.png" alt="{% trans "Remove" %}" />
        </a>
       {% endif %}
      </td>
     </tr>
    {% endfor %}
    <tr>
     <form action="/episode/{{ episode.id }}/add-chapter" method="POST">
      {% csrf_token %}
      <td>
       <input type="text" name="start" id="start" class="time" /> -
       <input type="text" name="end" id="end" class="time" />
      </td>
      <td>
       <input type="checkbox" name="advertisement" />
      </td>
      <td>
       <input type="text" name="label" />
      </td>
      <td>
       <input type="submit" value="{% trans "Add" %}" />
      </td>
     </form>
    </tr>
  </table>
  {% endif %}

  {% if history %}
  <h2>{% trans "History" %}</h2>
  <table class="list">
   <tr>
    <th>{% trans "Time" %}</th>
    <th>{% trans "Action" %}</th>
    <th>{% trans "Device" %}</th>
    <th></th>
   </tr>

   {% for s in history %}
    <tr>
     <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
     <td style="text-align: center;">{{ s|episode_status_icon }}</td>
     <td>
      {% if s.device %}
       <a href="/device/{{ s.device.id }}">{{ s.device|device_icon }} {{ s.device.name|striptags }}</a>
      {% endif %}
     </td>
     <td>{% if s.playmark %}{{ s.playmark_time|date:"H:m:s" }}{% endif %}
	</tr>
   {% endfor %}
  </table>
  {% endif %}

  {% if not episode.title %}
   <div class="info"><strong>{% trans "Why Unnamed Episode?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
  {% endif %}

{% endblock %}


{% block javascript %}
 <script type="text/javascript">
  $("#start").watermark("h:mm:ss", {className: 'watermark'});
  $("#end").watermark("h:mm:ss", {className: 'watermark'});

  {% if episode.url|is_youtube_video %}
   {{ episode|embed_youtube_video:user }}
  {% endif %}

 </script>
{% endblock javascript %}


{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load episodes %}
{% load devices %}
{% load podcasts %}
{% load mygpoutil %}
{% load time %}
{% load youtube %}
{% load flickr %}
{% load charts %}
{% load utils %}

{% load menu %}
{% block mainmenu %}{{ "/podcast/"|main_menu }}{% endblock %}
{% block sectionmenu %}
 {% if podcast.title %}
  {{ "/podcast/"|section_menu:podcast.title }}
 {% else %}
  {{ "/podcast/"|section_menu:"Unnamed Podcast" }}
 {% endif %}
{% endblock %}

{% block head %}
 {% if episode.url|is_youtube_video %}
  <script type="text/javascript" src="/media/js/swfobject.js"></script>
  <script type="text/javascript" src="/media/js/json2.js"></script>
  <script type="text/javascript" src="/media/js/youtube-handler.js"></script>
 {% endif %}

{% endblock head %}

{% block title %}
 {{ episode.title|default:"Unnamed Episode"|striptags }} -
 {{ podcast.title|default:"Unnamed Podcast"|striptags}}
{% endblock %}

{% block header %}

  {% if podcast.logo_url %}
   <div id="podcastlogo"><a href="{% podcast_link_target podcast %}">{{ podcast|podcast_logo_big }}</a></div>
  {% endif %}
  <h1>
   {{ episode.title|default:"Unnamed Episode"|striptags }}
   {% if episode.released %}
    <small>{{ episode.released|naturalday }}</small>
   {% endif %}
  </h1>
  <small class="description">
      {% trans "from" %} {% podcast_group_link podcast %}&middot;
       {% if not episode.outdated or "hide-outdated-urls" not in podcast.restrictions %}
        <a href="{{episode.url}}" title="{% trans "Download" %}">
         <i class="icon-download"></i>
        </a>
       {% endif %}
       {% if episode.link and episode.link != episode.url %}&middot;
        <a href="{{episode.link}}" title="{% trans "Website" %}">
         <i class="icon-external-link"></i>
        </a>
      {% endif %}
      {% if episode.listeners %}&middot;
       {{ episode.listeners }} {% trans "listeners" %}
      {% endif %}
  </small>


  {% if episode.summary or episode.description %}
   <div class="summary">
    {{ episode.summary|default:episode.description|truncatewords:100|markdown }}
   </div>
  {% endif %}

{% endblock %}



{% block content %}

  <hr />

 <div class="btn-toolbar">

  {% if is_publisher %}
   <a class="btn" href="{% episode_link_target episode podcast "episode-publisher-detail" %}"><i class="icon-wrench"></i> {% trans "Publisher Pages" %}</a>
  {% endif %}

  {% if user.is_authenticated %}
   {% if is_favorite %}
     <a class="btn" href="{% episode_link_target episode podcast "episode-fav" %}">
      <i class="icon-star"></i> {% trans "Remove Favorite" %}
     </a>
   {% else %}
     <a class="btn" href="{% episode_link_target episode podcast "episode-fav" %}">
      <i class="icon-star-empty"></i> {% trans "Favorite" %}
     </a>
   {% endif %}
  {% endif %}

   {% if has_history %}
    <a class="btn" href="{% episode_link_target episode podcast "episode-history" %}">
     <i class="icon-calendar"></i>
     {% trans "Episode History" %}
    </a>
   {% endif %}

  {% if can_flattr %}
   <a class="btn" href="{% episode_link_target episode podcast "flattr-episode" %}">
    <img src="https://flattr.com/_img/icons/flattr_logo_16.png"
     alt="Flattr {{ episode.title|default:"Unnamed Episode"|striptags }}" />
     {% trans "Flattr" %}
   </a>
  {% endif %}

 </div>

 <hr />

  {% if episode.content or episode.description %}
   <div class="description" {% if episode.language or podcast.language %}lang="{% firstof episode.language podcast.language %}"{% endif %}>
    {% if episode.content %}
     {{ episode.content|markdown }}
    {% else %}
     {{ episode.description|markdown }}
    {% endif %}
   </div>
  {% endif %}

  {% if episode.url|is_youtube_video %}
    <div id="ytapiplayer">
      You need Flash player 8+ and JavaScript enabled to view this video.
    </div>
  {% endif %}


  {% if episode.url|is_flickr_photo %}
   {{ episode|embed_flickr_photo }}
  {% endif %}

  {% if episode|is_image %}
   <img src="{{ episode.url }}" />
  {% endif %}

  {% if user.is_authenticated %}

   {% if played_parts %}
    <h3>Already played</h3>
    {{ played_parts|episode_heatmap_visualization }}
   {% endif %}

  {% endif %}

  <div class="pagination pagination-centered">
   <ul>
    {% if prev %}
     <li>
      {% episode_link prev podcast %}
     </li>
    {% endif %}
    <li>
     <a href="{% podcast_link_target podcast %}#episodes">{% trans "..." %}</a>
    </li>
    {% if next %}
     <li>
      {% episode_link next podcast %}
     </li>
    {% endif %}
   </ul>
  </div>

{% endblock %}


{% block sidebar %}


  {% if user.is_authenticated or chapters %}
    <div class="well">

   <h4>{% trans "Chapters" %}</h4>

   <table class="list">
    <tr>
     <th></th>
     <th>{% trans "Ad?" %}</th>
     <th>{% trans "Label" %}</th>
     <th></td>
    </tr>

    {% for chapter in chapters %}
     <tr {% if chapter.is_own %}class="own-chapter"{% endif %} >
      <td>{{ chapter.start|sec_to_time|time:"H:i:s" }}{% if chapter.start != chapter.end %} - {{ chapter.end|sec_to_time|time:"H:i:s" }}{% endif %}</td>
      <td>{% if chapter.advertisement %}Yes{% endif %}</td>
      <td>{{ chapter.label }}</strong>
      <td>
       {% if chapter.is_own %}
        <a href="{% episode_link_target episode "remove-chapter" chapter.start chapter.end %}">
         <img src="/media/unsubscribe.png" alt="{% trans "Remove" %}" />
        </a>
       {% endif %}
      </td>
     </tr>
    {% endfor %}
    {% if user.is_authenticated %}
    <tr>
     <form class="form-inline" action="{% episode_link_target episode podcast "add-chapter" %}" method="POST">
      {% csrf_token %}
      <td>
       <input class="input-mini" type="text" name="start" id="start" class="time" placeholder="h:mm:ss"/>
       <input class="input-mini" type="text" name="end" id="end" class="time" placeholder="h:mm:ss"/>
      </td>
      <td>
       <input type="checkbox" name="advertisement" />
      </td>
      <td>
       <input class="input-mini" type="text" name="label" />
      </td>
      <td>
       <input class="btn" type="submit" value="{% trans "Add" %}" />
      </td>
     </form>
    </tr>
    {% endif %}
  </table>
  </div>
  {% endif %}

{% endblock %}


{% block javascript %}
 <script type="text/javascript">

  {% if episode.url|is_youtube_video %}
   {% embed_youtube_video podcast episode user %}
  {% endif %}

 </script>
{% endblock javascript %}


{% block ads %}
 {% comment %}disable ads on episode pages{% endcomment %}
{% endblock %}

{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load episodes %}
{% load podcasts %}
{% load devices %}
{% load charts %}
{% load facebook %}
{% load google %}

{% load menu %}
{% block mainmenu %}{{ "/podcast/"|main_menu }}{% endblock %}
{% block sectionmenu %}
 {% if podcast.title %}
  {{ "/podcast/"|section_menu:podcast.title }}
 {% else %}
  {{ "/podcast/"|section_menu:"Unnamed Podcast" }}
 {% endif %}
{% endblock %}

{% block head %}
 {{ podcast|opengraph_podcast }}
 {% google_plus_one_head %}
{% endblock %}

{% block title %}{{ podcast.title|default:"Unnamed Podcast"|striptags }}{% endblock %}

{% block content %}

 <div class="row-fluid">

  <span class="span12">

   {% if podcast.logo_url %}
    <div id="podcastlogo">{{ podcast|podcast_logo_big }}</div>
   {% endif %}

   <h1>
    {% if podcast.title %}
     {{ podcast.title|striptags }}
    {% else %}
     {% trans "Unnamed Podcast" %}
    {%endif%}
   </h1>

   <small class="description">
    {% trans "links" %}:
    <a href="{{podcast.url}}">
     {% trans "feed" %}
    </a>
    {% if podcast.link %},
     <a href="{{podcast.link}}">{% trans "website" %}</a>
    {% endif %},
    {% blocktrans with podcast.subscriber_count as subscriber_count and podcast.listener_count as listener_count %}{{subscriber_count}} subscribers, {{listener_count}} listeners{% endblocktrans %}
   </small>

   {% if related_podcasts %}
    <div class="related-podcasts">
     <strong>{% trans "Also available" %}</strong>
     {% for p in related_podcasts %}
      {% podcast_group_link p p.group_member_name %}
     {% endfor %}
    </div>
   {% endif %}

   {% if podcast.description %}
    <p class="description">{{ podcast.description|striptags }}</p>
   {% endif %}

  </div>
 </div>



 <div class="row-fluid">

 <div class="span8">

  {% if episode %}
   <div class="first-episode">

    <h2>{{ episode.title }} <small>{{ episode.released|naturalday }}</small></h2>
    <div class="description">
     {{ episode.description|default:""|striptags }}
    </div>
    <a href="{% episode_link_target episode podcast %}">more...</a>

   </div>
  {% endif %}

  {% if episodes %}

  <h3>{% trans "Older Episodes" %}</h3>
   <table class="list episode_list" id="episodes">
    <tr>
     <th></th>
     <th>{% trans "Title" %}</th>
     <th>{% trans "Released" %}</th>
     <th>{% trans "Listeners" %}</th>
    </tr>

    {% for episode in episodes %}
     <tr>
      <td>{{ episode.action|episode_status_icon }}</td>
      <td class="short">
          <div class="title">{% episode_link episode podcast %}</div>
          <p class="description short">{{ episode.description|default:""|striptags }}</p>
      </td>
      <td>{{ episode.released|default:""|date:"Y-m-d" }}</td>
      <td>
       {% if episode.listeners %}
        {{ episode.listeners|vertical_bar:max_listeners }}
       {% endif %}
      </td>
     </tr>
    {% endfor %}
   </table>
  {% endif %}

 </div>


 <div class="span4">

  <div class="row-fluid">

  <div class="well">
   <h3>{% trans "Subscriptions" %}</h3>
   {% if not user.is_authenticated %}
    <div class="subscribe">
     <a href="{% podcast_link_target podcast "subscribe" %}">
      <img src="/media/subscribe.png" style="vertical-align: middle;" alt=""/>
      {% trans "Subscribe to this podcast" %}
     </a>
    </div>
   {% endif %}

   {% if devices or can_subscribe %}
    <table class="list">
      {% for device in devices %}
       <tr>
        <td>
         {{ device|device_icon }}
         <a href="{% url device device.uid %}">{{ device.name|striptags }}</a>
        </td>
        <td style="text-align: center;">
         <form class="form-inline" method="post" action="{% podcast_link_target podcast "unsubscribe" device.uid %}?return_to={% podcast_link_target podcast %}">
          <button class="btn btn-danger" type="submit">
           <i class="icon-remove"></i>
          </button>
         </form>
        </td>
       </tr>
      {% endfor %}
      {% if can_subscribe %}
       <tr>
        <form class="form-inline" action="{% podcast_link_target podcast "subscribe" %}" method="post">
         {% csrf_token %}
         <td>{{ subscribe_form.as_p }}</td>
         <td style="text-align: center;">
          <button class="btn btn-success" type="submit">
           <i class="icon-ok"></i>
          </button>
         </td>
        </form>
       </tr>
      {% endif %}
     </table>
   {% endif %}
  </div>

  </div>


  <div class="row-fluid">

  <div class="well">
   <h3>Tags</h3>

   {% for tag in tags %}
    {% spaceless %}
     {% if tag.is_own %}
      <span class="own">{{ tag.tag }} <a class="remove" href="{% podcast_link_target podcast "remove-tag" %}?tag={{ tag.tag }}">X</a></span>
     {% else %}
       <span class="other">{{ tag.tag }}</span>
     {% endif %}
     {% if not forloop.last %}
      <span class="seperator">,</span>
     {% endif %}
    {% endspaceless %}
   {% endfor %}

   {% if user.is_authenticated %}
    <form class="form-inline" action="{% podcast_link_target podcast "add-tag" %}">
     <div class="input-prepend">
      <span class="add-on"><i class="icon-tag"></i></span><input class="input-small" type="text" name="tag" />
     </div>
     <button class="btn btn-success" type="submit">
      <i class="icon-plus"></i>
     </button>
    </form>
   {% endif %}
  </div>

  </div>

  <div class="row-fluid">

  <div class="well">
   <h3>{% trans "Share" %}</h3>

   {% google_plus_one_button %}
   {{ podcast|fb_like_podcast }}

  </div>
 </div>


  {% if history %}
 <div class="row-fluid">

  <div class="well">
   <h3>{% trans "Subscription History" %}</h3>
   <table class="list">
    {% for s in history %}
     <tr>
      <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
      <td>{{ s|podcast_status_icon }}</td>
      <td>
       <a href="{% url device s.device.uid %}">{{ s.device|device_icon }} {{ s.device.name|striptags }}</a>
      </td>
     </tr>
    {% endfor %}
   </table>
  </div>
  </div>
  {% endif %}

  {% if not podcast.title %}
   <div class="info"><strong>{% trans "Why Unnamed Podcast?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
  {% endif %}

{% endblock %}


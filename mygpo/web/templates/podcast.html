{% extends "podcast-base.html" %}
{% load i18n %}
{% load humanize %}
{% load episodes %}
{% load podcasts %}
{% load devices %}
{% load charts %}
{% load facebook %}
{% load google %}
{% load utils %}

{% load menu %}
{% block mainmenu %}{{ "/podcast/"|main_menu }}{% endblock %}
{% block sectionmenu %}
 {% if podcast.title %}
  {{ "/podcast/"|section_menu:podcast.title }}
 {% else %}
  {{ "/podcast/"|section_menu:"Unnamed Podcast" }}
 {% endif %}
{% endblock %}

{% block title %}{{ podcast.title|default:"Unnamed Podcast"|striptags }}{% endblock %}


{% block content %}

  {% if episode %}
   <div class="first-episode">

    <h2>{{ episode.title }} <small>{{ episode.released|naturalday }}</small></h2>
    <div class="description" {% if episode.language or podcast.language %}lang="{% firstof episode.language podcast.language %}"{% endif %}>
     {{ episode.description|default:""|truncatewords:"100"|markdown }}
    </div>
    <a href="{% episode_link_target episode podcast %}">more...</a>

   </div>
  {% endif %}

 <hr />

 <div class="btn-toolbar">

  {% if is_publisher %}
   <div class="btn-group">
    <a class="btn" href="{% podcast_link_target podcast "podcast-publisher-detail" %}">
     <i class="icon-wrench"></i>
     {% trans "Publisher Pages" %}
    </a>
   </div>
  {% endif %}

  {% if not user.is_authenticated %}
   <div class="btn-group">
    <a class="btn" href="{% podcast_link_target podcast "subscribe" %}">
     <i class="icon-plus"></i>
     {% trans "Login to Subscribe" %}
    </a>
   </div>
  {% endif %}

  {% if devices or can_subscribe %}

   <div class="btn-group">
    {% if can_subscribe %}
     <button class="btn btn-primary" onclick="submitForm('subscribe+all');">
      <i class="icon-plus-sign"></i>
      {% trans "Subscribe" %}
     </button>
    {% else %}
     <button class="btn" onclick="submitForm('unsubscribe+all');">
      <i class="icon-remove-sign"></i>
      {% trans "Unsubscribe" %}
     </button>
    {% endif %}
    <button class="btn dropdown-toggle btn-primary" data-toggle="dropdown">
     <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
     {% if can_subscribe %}
      <li value="+all">
       <a href="javascript:void(0);" onclick="submitForm('subscribe+all');">
        <i class="icon-plus-sign"></i>
        {% trans "Subscribe on all devices" %}
       </a>
       <form class="internal"
             method="post"
             action="{% podcast_link_target podcast "subscribe-all" %}"
             id="subscribe+all">
        {% csrf_token %}
       </form>
      </li>
     {% endif %}
     {% for device in subscribe_targets %}
      <li value="{{ device.uid }}">
       <a href="javascript:void(0);" onclick="submitForm('subscribe-{{ device|devices_uids }}');">
        <i class="icon-plus"></i>
        {{ device|devices_name }}
       </a>
       <form class="internal"
             action="{% podcast_link_target podcast "subscribe" %}"
             method="post"
             id="subscribe-{{ device|devices_uids }}">
         {% csrf_token %}
         <input type="hidden" name="targets" value="{{ device|devices_uids }}" />
       </form>
      </li>
     {% endfor %}
     {% if can_subscribe and devices %}
      <li class="divider"></li>
     {% endif %}
     {% if devices %}
      <li value="+none">
       <a href="javascript:void(0);" onclick="submitForm('unsubscribe+all');">
        <i class="icon-remove-sign"></i>
        {% trans "Unsubscribe from all devices " %}
       </a>
       <form class="internal"
             method="post"
             action="{% podcast_link_target podcast "unsubscribe-all" %}"
             id="unsubscribe+all">
        {% csrf_token %}
       </form>
      </li>
     {% endif %}
     {% for device in devices %}
      <li value="{{ device.uid }}">
       <a href="javascript:void(0);" onclick="submitForm('unsubscribe-{{ device.uid }}');">
        <i class="icon-remove"></i>
        {{ device|devices_name }}
       </a>
       <form class="internal"
             method="post"
             action="{% podcast_link_target podcast "unsubscribe" device.uid %}?return_to={% podcast_link_target podcast %}"
             id="unsubscribe-{{ device.uid }}">
        {% csrf_token %}
       </form>
      </li>
     {% endfor %}
    </ul>
   </div>

  {% endif %}


   {% if has_history %}
    <a class="btn" href="{% podcast_link_target podcast "podcast-history" %}">
     <i class="icon-calendar"></i>
     {% trans "Subscription History" %}
    </a>
   {% endif %}

  </div>

 <hr />


  {% if episodes %}

  <h3>{% trans "Older Episodes" %}</h3>
   <table class="list episode_list" id="episodes">
    <tr>
     <th></th>
     <th>{% trans "Title" %}</th>
     <th>{% trans "Released" %}</th>
     <th>{% trans "Listeners" %}</th>
    </tr>

    {% for episode in episodes %}
     <tr>
      <td>{{ episode.action|episode_status_icon }}</td>
      <td class="short">
          <div class="title">{% episode_link episode podcast %}</div>
          <div class="description short">{{ episode.subtitle|default:episode.description|default:""|truncatewords:"20"|markdown|striptags }}</div>
      </td>
      <td>{{ episode.released|default:""|date:"Y-m-d" }}</td>
      <td>
       {% if episode.listeners %}
        {% vertical_bar episode.listeners max_listeners %}
       {% endif %}
      </td>
     </tr>
    {% endfor %}

    {% if not podcast.episode_count or podcast.episode_count > 20 %}
    <tr>
     <td></td>
     <td>
      <a href="{% podcast_link_target podcast "podcast-all-episodes" %}?page=2">{% trans "All Episodes" %}</a>
     </td>
     <td></td>
     <td></td>
    </tr>
    {% endif %}

   </table>
  {% endif %}

{% endblock %}


{% block sidebar %}

  <div class="well">
   <h4>Tags</h4>

   {% for tag in tags %}
    {% spaceless %}
     {% if tag.is_own %}
      <span class="own">{{ tag.tag }} <a class="remove" href="{% podcast_link_target podcast "remove-tag" %}?tag={{ tag.tag }}">X</a></span>
     {% else %}
       <span class="other">{{ tag.tag }}</span>
     {% endif %}
     {% if not forloop.last %}
      <span class="seperator">,</span>
     {% endif %}
    {% endspaceless %}
   {% endfor %}

   {% if user.is_authenticated %}
    <form class="form-inline" action="{% podcast_link_target podcast "add-tag" %}">
     <div class="input-prepend btn-append">
      <span class="add-on"><i class="icon-tag"></i></span><input class="input-small" type="text" name="tag" /><button class="btn btn-success" type="submit">
      <i class="icon-plus"></i>
     </button>
     </div>
    </form>
   {% endif %}
  </div>

  <div class="well">
   <h4>{% trans "Share" %}</h4>

   {% google_plus_one_button %}
   {{ podcast|fb_like_podcast }}
   {% if can_flattr %}
    <a href="{% podcast_link_target podcast "podcast-flattr" %}">
     <img src="https://api.flattr.com/button/flattr-badge-large.png"
      alt="Flattr {{ podcast.title|default:"Unnamed Podcast"|striptags }}" />
    </a>
   {% endif %}

 </div>

{% endblock %}


{% block javascript %}

    <script language="javascript">
        <!--
        function submitForm(formid)
        {
            document.forms[formid].submit();
            return true;
        }
        -->
    </script>

{% endblock %}
